<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Pattern Formation in Economic Geography | Ian Helfrich</title>
    <meta name="description" content="Inverse problem solver for spatial economics: estimate nonlocal interaction kernels from observed population distributions">
    <meta name="author" content="Ian Helfrich">

    <!-- Modern libraries for high-performance computation -->
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600&family=JetBrains+Mono:wght@400;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111;
            --bg-tertiary: #1a1a1a;
            --accent: #575ECF;
            --accent-bright: #8b92ff;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9691;
            --text-muted: #6b6b6b;
            --border: rgba(255,255,255,0.05);
            --border-bright: rgba(87, 94, 207, 0.3);
            --warn: #ff6b6b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .tagline {
            color: var(--text-secondary);
            font-size: clamp(0.875rem, 2vw, 1rem);
            margin-bottom: 1rem;
            font-weight: 300;
        }

        .author {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 300;
        }

        .author a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .author a:hover {
            border-bottom-color: var(--accent);
        }

        .problem-statement {
            background: var(--bg-secondary);
            border-left: 2px solid var(--accent);
            padding: 1.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.7;
            margin-bottom: 2rem;
        }

        .problem-statement strong {
            color: var(--accent-bright);
            font-weight: 500;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .param-control {
            margin-bottom: 1.25rem;
        }

        .param-control label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .param-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .param-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-bright);
            font-size: 0.8rem;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--accent-bright);
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: block;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s;
            margin-bottom: 0.75rem;
        }

        .file-upload-label:hover {
            border-color: var(--accent);
            color: var(--accent-bright);
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        button.active {
            background: var(--accent);
            border-color: var(--accent-bright);
        }

        .diagnostics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .diagnostic-item {
            font-size: 0.75rem;
        }

        .diagnostic-label {
            color: var(--text-muted);
            display: block;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .diagnostic-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-bright);
            font-size: 0.875rem;
        }

        .visualization-area {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .canvas-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .canvas-header {
            margin-bottom: 0.75rem;
        }

        .canvas-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
        }

        canvas {
            width: 100%;
            height: auto;
            border-radius: 4px;
            background: #000;
        }

        .methodology {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .methodology h2 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .method-steps {
            display: grid;
            gap: 1.25rem;
        }

        .step {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content h3 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
            color: var(--text-primary);
        }

        .step-content p {
            font-size: 0.8125rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .equation {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            color: var(--accent-bright);
            overflow-x: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.375rem;
        }

        .status-stable { background: #4ade80; }
        .status-critical { background: #fbbf24; }
        .status-unstable { background: var(--warn); }

        .data-mode {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .data-mode strong {
            color: var(--accent-bright);
            display: block;
            margin-bottom: 0.375rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Inverse Problem: Estimating Spatial Interaction Kernels</h1>
            <p class="tagline">Parameter recovery from observed population distributions</p>
            <p class="author">Ian Helfrich · <a href="mailto:ian@helfrich.com">Contact</a></p>
        </header>

        <div class="problem-statement">
            <strong>Research Question:</strong> Can nonlocal interaction kernels K(x) be recovered from observed spatial distributions of economic activity? Given LandScan population density data across years, can temporal changes reveal the underlying PDE governing spatial reallocation? The governing equation is ∂ₜy = M(κΔy + λ(K*y) - α(y-y₀)³), but κ, λ, α, K are unknown. Standard models assume local interactions only. This tool attempts parameter estimation via dispersion matching and energy minimization.
        </div>

        <div class="main-grid">
            <div class="controls">
                <div class="control-section">
                    <h3>Data Source</h3>
                    <div class="data-mode" id="dataMode">
                        <strong>Mode: Synthetic</strong>
                        Load GeoTIFF to switch to parameter estimation mode
                    </div>
                    <label class="file-upload-label" for="geotiffUpload">
                        Load GeoTIFF (LandScan)
                    </label>
                    <input type="file" id="geotiffUpload" accept=".tif,.tiff">
                    <button id="reset">Reset Field</button>
                    <button id="toggleSim" class="active">Pause</button>
                </div>

                <div class="control-section">
                    <h3>PDE Parameters</h3>
                    <div class="param-control">
                        <label>
                            <span class="param-name">λ (coupling)</span>
                            <span class="param-value" id="lambda-val">0.150</span>
                        </label>
                        <input type="range" id="lambda" min="0" max="0.3" step="0.001" value="0.15">
                    </div>
                    <div class="param-control">
                        <label>
                            <span class="param-name">κ (diffusion)</span>
                            <span class="param-value" id="kappa-val">0.003</span>
                        </label>
                        <input type="range" id="kappa" min="0.001" max="0.01" step="0.0001" value="0.003">
                    </div>
                    <div class="param-control">
                        <label>
                            <span class="param-name">α (congestion)</span>
                            <span class="param-value" id="alpha-val">1.000</span>
                        </label>
                        <input type="range" id="alpha" min="0.1" max="5" step="0.1" value="1.0">
                    </div>
                    <div class="param-control">
                        <label>
                            <span class="param-name">σ₁ (attract)</span>
                            <span class="param-value" id="sigma1-val">2.0</span>
                        </label>
                        <input type="range" id="sigma1" min="0.5" max="10" step="0.1" value="2.0">
                    </div>
                    <div class="param-control">
                        <label>
                            <span class="param-name">σ₂ (repel)</span>
                            <span class="param-value" id="sigma2-val">5.0</span>
                        </label>
                        <input type="range" id="sigma2" min="1" max="15" step="0.1" value="5.0">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Stability Analysis</h3>
                    <div class="diagnostics">
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">λ / λc</span>
                            <span class="diagnostic-value" id="lambda-ratio">—</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">Status</span>
                            <span class="diagnostic-value">
                                <span class="status-indicator status-critical"></span>
                                <span id="stability-status">Critical</span>
                            </span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">k_max</span>
                            <span class="diagnostic-value" id="dominant-k">—</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">ℓ (km)</span>
                            <span class="diagnostic-value" id="char-scale">—</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">Energy</span>
                            <span class="diagnostic-value" id="energy">—</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">Time</span>
                            <span class="diagnostic-value" id="time">0.00</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">FPS</span>
                            <span class="diagnostic-value" id="fps">60</span>
                        </div>
                        <div class="diagnostic-item">
                            <span class="diagnostic-label">Compute</span>
                            <span class="diagnostic-value" id="compute-mode">GPU</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization-area">
                <div class="canvas-grid">
                    <div class="canvas-container">
                        <div class="canvas-header">
                            <h3 class="canvas-title">Population Density Field y(x,t)</h3>
                        </div>
                        <canvas id="fieldCanvas" width="400" height="400"></canvas>
                    </div>

                    <div class="canvas-container">
                        <div class="canvas-header">
                            <h3 class="canvas-title">Interaction Kernel K(x)</h3>
                        </div>
                        <canvas id="kernelCanvas" width="400" height="400"></canvas>
                    </div>

                    <div class="canvas-container">
                        <div class="canvas-header">
                            <h3 class="canvas-title">Dispersion Relation σ(k)</h3>
                        </div>
                        <canvas id="dispersionCanvas" width="400" height="400"></canvas>
                    </div>

                    <div class="canvas-container">
                        <div class="canvas-header">
                            <h3 class="canvas-title">Power Spectrum |ŷ(k)|²</h3>
                        </div>
                        <canvas id="spectrumCanvas" width="400" height="400"></canvas>
                    </div>
                </div>

                <div class="methodology">
                    <h2>Methodology: Parameter Estimation from Spatial Data</h2>
                    <div class="method-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Load Observed Distribution</h3>
                                <p>Import GeoTIFF raster (LandScan population density). Resample to computational grid. Normalize to preserve total population. This becomes the target distribution y*(x) for parameter fitting.</p>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Compute Empirical Spectrum</h3>
                                <p>FFT of observed field gives |ŷ*(k)|². Peak wavenumber k_max indicates dominant spatial scale. Compare to theoretical prediction from dispersion relation.</p>
                                <div class="equation">ŷ(k) = ∫ y(x) e^(-ik·x) dx</div>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>Match Dispersion Relation</h3>
                                <p>Theoretical growth rate σ(k) = M(-κk² + λK̂(k)). Fit κ, λ such that argmax σ(k) matches observed k_max. Kernel shape (σ₁, σ₂) determines K̂(k).</p>
                                <div class="equation">σ(k) = M(-κ|k|² + λK̂(k))</div>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h3>Minimize Energy Distance</h3>
                                <p>Run PDE forward from random initial condition. Compute L² distance ‖y - y*‖ and energy mismatch. Gradient descent on (κ, λ, α, σ₁, σ₂) to minimize objective.</p>
                                <div class="equation">L = ‖y - y*‖² + β|E[y] - E[y*]|</div>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h3>Temporal Prediction</h3>
                                <p>With recovered parameters, integrate PDE forward in time. Predict spatial distribution at t+Δt. Compare to actual LandScan data from subsequent year. Measure prediction error.</p>
                            </div>
                        </div>

                        <div class="step">
                            <div class="step-number">6</div>
                            <div class="step-content">
                                <h3>Cross-Validation</h3>
                                <p>Fit on year t, validate on t+1. Check if same parameters generalize. If not, kernel may be time-varying K(x;t) or parameters may depend on external factors (trade shocks, policy changes).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="simulation.js"></script>
</body>
</html>
